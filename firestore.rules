/**
 * This ruleset enforces a strict user-ownership model for the 'Future Impact Analyzer' application.
 *
 * Core Philosophy:
 * All user data is considered private and can only be accessed by the user who owns it.
 * The security model relies on the authenticated user's ID (UID) to grant access, ensuring
 * a clear and non-permissive security posture from the root.
 *
 * Data Structure:
 * The data is organized hierarchically. A top-level `/users` collection holds user profiles,
 * and all other user-specific data, such as financial simulations, are stored in subcollections
 * under the user's specific document (e.g., `/users/{their-own-userId}/financialSimulations`).
 *
 * This structure is critical for security and scalability, as it allows frontend queries to
 * request only the data for a specific user, and the rules can efficiently validate those requests.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // == HELPER FUNCTIONS ==
    // These functions make the rules easier to read and maintain.

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId from the path.
     * This is the primary function for enforcing user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Combines an ownership check with a check that the document already exists.
     * Used for all update and delete operations to prevent modifying non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/financialSimulations/$(resource.id));
    }
    
    /**
     * Validates required fields for creating a new UserProfile.
     * Ensures the document ID being created matches the authenticated user's ID.
     */
    function isValidUserProfileCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates fields for updating a UserProfile.
     * Enforces the immutability of the 'id' field to prevent re-assigning ownership.
     */
    function isValidUserProfileUpdate() {
      return request.resource.data.id == resource.data.id;
    }
    
    /**
     * Validates required fields for creating a new FinancialSimulation.
     * This rule ensures the denormalized `userId` field in the document's body
     * correctly points back to the parent user, establishing the ownership link.
     */
    function isValidFinancialSimulationCreate(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * Validates fields for updating a FinancialSimulation.
     * This rule enforces the immutability of the `userId` field, preventing the
     * simulation from being reassigned to another user.
     */
    function isValidFinancialSimulationUpdate() {
      return request.resource.data.userId == resource.data.userId;
    }

    // == COLLECTION RULES ==

    /**
     * @description Rules for the UserProfile document.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all users for privacy.
      allow create: if isOwner(userId) && isValidUserProfileCreate(userId);
      allow update: if isOwner(userId) && isValidUserProfileUpdate();
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for a user's financial simulation documents.
     * @path /users/{userId}/financialSimulations/{simulationId}
     * These rules secure the subcollection containing each user's private financial simulations.
     */
    match /users/{userId}/financialSimulations/{simulationId} {

      // READ (get, list)
      // A user can read a single simulation (get) or a list of their own simulations (list).
      // This rule works with the frontend query that fetches from `/users/$(request.auth.uid)/financialSimulations`.
      allow read: if isOwner(userId);

      // CREATE
      // A user can create a new simulation document in their own subcollection.
      // We also enforce that the document data itself contains their `userId` to ensure data integrity.
      allow create: if isOwner(userId) && isValidFinancialSimulationCreate(userId);

      // UPDATE, DELETE
      // A user can update or delete their own existing simulation documents.
      allow update: if isExistingOwner(userId) && isValidFinancialSimulationUpdate();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the public 'experts' collection.
     * @path /experts/{expertId}
     */
    match /experts/{expertId} {
      // Anyone can read the list of experts.
      allow get, list: if true;
      // Allow signed-in users to create experts (for the one-time data seeding).
      allow create: if isSignedIn();
      // Other writes are disabled for clients; this should be managed by an admin/backend process.
      allow update, delete: if false;
    }
  }
}
